/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2023 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "adc.h"
#include "spi.h"
#include "ucpd.h"
#include "usart.h"
#include "usb_otg.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "arm_math.h"
#include "arm_const_structs.h"
#include "sonar.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */

const int EINT_STATUS_MASK =  1 << 23;
const int BINT_STATUS_MASK = 0x080000;
const int RRINT_STATUS_MASK = 0x000400;
const int FIFO_OVF_MASK =  0x7;
const int FIFO_VALID_SAMPLE_MASK =  0x0;
const int FIFO_FAST_SAMPLE_MASK =  0x1;
const int FIFO_RANGE_SAMPLE_MASK = 0x1;
const int ETAG_BITS_MASK = 0x7;
const int BTAG_BITS_MASK = 0x7;


#define NUM_STAGES_2ORDER 1 // Number of biquad stages
#define BLOCK_SIZE 1// Number of samples to process at a time
#define SAMPLE_RATE 32
#define PAST_SAMPLE_BUFFER (SAMPLE_RATE * 3) //sample rate * n, n decides the second in samples to look back at
#define NUM_TAPS 512
#define WINDOW_BASELINE 60*32*7
#define WINDOW 30*32

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */
uint32_t idx;
int ecgFIFOIntFlag;
uint8_t receivedData[8];

float32_t phasicCoeffsFIR[NUM_TAPS] = {
    // Stage 1
		-8.07102186174787e-05,-8.12065045690491e-05,-8.17773022325704e-05,-8.24238547784548e-05,-8.31474115981145e-05,-8.39492283307793e-05,-8.48305668940252e-05,-8.57926955175458e-05,-8.6836888780736e-05,-8.79644276539039e-05,-8.91765995434061e-05,-9.04746983408026e-05,-9.18600244761432e-05,-9.33338849754342e-05,-9.48975935228072e-05,-9.65524705268698e-05,-9.82998431921735e-05,-0.000100141045595229,-0.000102077418765823,-0.000104110310773355,-0.000106241076818658,-0.00010847107933134,-0.000110801688072885,-0.000113234280245516,-0.000115770240607543,-0.000118410961594507,-0.000121157843447357,-0.00012401229434691,-0.00012697573055561,-0.000130049576566184,-0.000133235265257879,-0.000136534238060259,-0.000139947945124878,-0.0001434778455051,-0.000147125407344495,-0.000150892108073473,-0.000154779434615492,-0.000158788883601901,-0.000162921961596859,-0.000167180185331708,-0.000171565081949823,-0.000176078189261817,-0.000180721056011651,-0.000185495242154035,-0.00019040231914336,-0.000195443870234452,-0.000200621490796201,-0.000205936788637245,-0.000211391384345613,-0.000216986911641399,-0.000222725017744021,-0.000228607363753768,-0.000234635625048568,-0.000240811491696365,-0.000247136668883624,-0.000253612877360241,-0.000260241853902435,-0.000267025351792481,-0.000273965141317947,-0.000281063010289167,-0.000288320764577203,-0.000295740228671791,-0.000303323246260795,-0.000311071680831543,-0.000318987416294804,-0.000327072357632442,-0.000335328431569736,-0.000343757587272175,-0.000352361797069688,-0.000361143057206825,-0.000370103388622168,-0.000379244837756175,-0.00038856947738988,-0.000398079407514787,-0.00040777675623538,-0.000417663680705778,-0.000427742368101298,-0.000438015036626326,-0.000448483936561052,-0.000459151351346182,-0.000470019598710015,-0.000481091031836878,-0.000492368040580647,-0.000503853052723713,-0.000515548535283938,-0.000527456995871486,-0.000539580984097275,-0.000551923093034829,-0.000564485960739593,-0.000577272271824624,-0.000590284759099121,-0.000603526205268595,-0.000616999444702361,-0.000630707365268916,-0.000644652910243793,-0.00065883908029137,-0.000673268935525928,-0.000687945597652852,-0.000702872252195925,-0.000718052150812719,-0.000733488613703131,-0.000749185032114188,-0.000765144870947016,-0.000781371671468516,-0.00079786905413454,-0.000814640721528128,-0.000831690461419627,-0.000849022149952314,-0.000866639754962042,-0.000884547339434702,-0.000902749065110129,-0.000921249196237473,-0.000940052103491991,-0.000959162268057855,-0.000978584285888241,-0.000998322872149219,-0.00101838286585793,-0.00103876923472361,-0.00105948708020361,-0.0010805416427827,-0.00110193830748975,-0.00112368260966202,-0.00114578024097186,-0.00116823705572701,-0.00119105907746226,-0.00121425250583493,-0.00123782372384297,-0.0012617793053806,-0.00128612602315355,-0.00131087085696924,-0.00133602100242681,-0.00136158388002672,-0.00138756714472498,-0.0014139786959561,-0.00144082668815391,-0.00146811954179589,-0.00149586595500454,-0.00152407491573661,-0.00155275571459683,-0.00158191795831091,-0.00161157158390133,-0.00164172687360525,-0.00167239447058289,-0.00170358539546287,-0.00173531106378073,-0.00176758330436209,-0.00180041437871557,-0.00183381700149728,-0.00186780436211808,-0.00190239014756736,-0.00193758856653652,-0.0019734143749252,-0.00200988290282735,-0.0020470100830956,-0.0020848124815949,-0.00212330732925937,-0.00216251255608416,-0.00220244682718477,-0.00224312958107595,-0.00228458107032741,-0.00232682240477559,-0.00236987559747413,-0.00241376361359396,-0.0024585104224925,-0.00250414105319551,-0.00255068165355465,-0.00259815955337056,-0.00264660333179082,-0.00269604288932855,-0.00274650952487308,-0.00279803601810335,-0.00285065671774756,-0.00290440763618481,-0.00295932655092122,-0.00301545311353466,-0.00307282896673393,-0.00313149787025208,-0.00319150583635411,-0.00325290127583489,-0.00331573515546044,-0.00338006116791925,-0.00344593591545363,-0.00351341910847847,-0.00358257378063021,-0.00365346652185806,-0.00372616773134553,-0.00380075189226288,-0.00387729787057674,-0.00395588924041705,-0.0040366146387911,-0.00411956815278588,-0.00420484974277995,-0.00429256570563819,-0.00438282918236401,-0.00447576071527247,-0.00457148886040933,-0.00467015086172118,-0.00477189339435941,-0.00487687338553974,-0.00498525892256083,-0.00509723025897909,-0.00521298093154333,-0.00533271900238454,-0.00545666844315639,-0.00558507068042698,-0.00571818632466672,-0.00585629710880106,-0.00599970806656942,-0.0061487499860341,-0.00630378217965624,-0.00646519561964469,-0.00663341649603112,-0.00680891026550303,-0.00699218627181816,-0.00718380303421739,-0.00738437431928757,-0.00759457613511724,-0.00781515481543202,-0.00804693639717448,-0.00829083753958349,-0.00854787828873431,-0.00881919706197549,-0.00910606831612716,-0.00940992347747615,-0.00973237585841642,-0.0100752504756968,-0.0104406199333751,-0.0108308478600506,-0.0112486418232856,-0.01169711822462,-0.0121798824639743,-0.0127011287361182,-0.0132657653070587,-0.0138795731974274,-0.0145494091495719,-0.0152834679996084,-0.0160916257793005,-0.0169858940941756,-0.0179810302883851,-0.0190953694876427,-0.0203519787232531,-0.0217802886246457,-0.0234184503085346,-0.0253168235748083,-0.0275432850306421,-0.0301915694283102,-0.0333948792162711,-0.0373491008320955,-0.0423545940296344,-0.0488965559695955,-0.0578130552269706,-0.070687111141511,-0.0909109091973645,-0.127304133313503,-0.212205627295331,-0.636664993703908,0.636664993703908,0.212205627295331,0.127304133313503,0.0909109091973645,0.070687111141511,0.0578130552269706,0.0488965559695955,0.0423545940296344,0.0373491008320955,0.0333948792162711,0.0301915694283102,0.0275432850306421,0.0253168235748083,0.0234184503085346,0.0217802886246457,0.0203519787232531,0.0190953694876427,0.0179810302883851,0.0169858940941756,0.0160916257793005,0.0152834679996084,0.0145494091495719,0.0138795731974274,0.0132657653070587,0.0127011287361182,0.0121798824639743,0.01169711822462,0.0112486418232856,0.0108308478600506,0.0104406199333751,0.0100752504756968,0.00973237585841642,0.00940992347747615,0.00910606831612716,0.00881919706197549,0.00854787828873431,0.00829083753958349,0.00804693639717448,0.00781515481543202,0.00759457613511724,0.00738437431928757,0.00718380303421739,0.00699218627181816,0.00680891026550303,0.00663341649603112,0.00646519561964469,0.00630378217965624,0.0061487499860341,0.00599970806656942,0.00585629710880106,0.00571818632466672,0.00558507068042698,0.00545666844315639,0.00533271900238454,0.00521298093154333,0.00509723025897909,0.00498525892256083,0.00487687338553974,0.00477189339435941,0.00467015086172118,0.00457148886040933,0.00447576071527247,0.00438282918236401,0.00429256570563819,0.00420484974277995,0.00411956815278588,0.0040366146387911,0.00395588924041705,0.00387729787057674,0.00380075189226288,0.00372616773134553,0.00365346652185806,0.00358257378063021,0.00351341910847847,0.00344593591545363,0.00338006116791925,0.00331573515546044,0.00325290127583489,0.00319150583635411,0.00313149787025208,0.00307282896673393,0.00301545311353466,0.00295932655092122,0.00290440763618481,0.00285065671774756,0.00279803601810335,0.00274650952487308,0.00269604288932855,0.00264660333179082,0.00259815955337056,0.00255068165355465,0.00250414105319551,0.0024585104224925,0.00241376361359396,0.00236987559747413,0.00232682240477559,0.00228458107032741,0.00224312958107595,0.00220244682718477,0.00216251255608416,0.00212330732925937,0.0020848124815949,0.0020470100830956,0.00200988290282735,0.0019734143749252,0.00193758856653652,0.00190239014756736,0.00186780436211808,0.00183381700149728,0.00180041437871557,0.00176758330436209,0.00173531106378073,0.00170358539546287,0.00167239447058289,0.00164172687360525,0.00161157158390133,0.00158191795831091,0.00155275571459683,0.00152407491573661,0.00149586595500454,0.00146811954179589,0.00144082668815391,0.0014139786959561,0.00138756714472498,0.00136158388002672,0.00133602100242681,0.00131087085696924,0.00128612602315355,0.0012617793053806,0.00123782372384297,0.00121425250583493,0.00119105907746226,0.00116823705572701,0.00114578024097186,0.00112368260966202,0.00110193830748975,0.0010805416427827,0.00105948708020361,0.00103876923472361,0.00101838286585793,0.000998322872149219,0.000978584285888241,0.000959162268057855,0.000940052103491991,0.000921249196237473,0.000902749065110129,0.000884547339434702,0.000866639754962042,0.000849022149952314,0.000831690461419627,0.000814640721528128,0.00079786905413454,0.000781371671468516,0.000765144870947016,0.000749185032114188,0.000733488613703131,0.000718052150812719,0.000702872252195925,0.000687945597652852,0.000673268935525928,0.00065883908029137,0.000644652910243793,0.000630707365268916,0.000616999444702361,0.000603526205268595,0.000590284759099121,0.000577272271824624,0.000564485960739593,0.000551923093034829,0.000539580984097275,0.000527456995871486,0.000515548535283938,0.000503853052723713,0.000492368040580647,0.000481091031836878,0.000470019598710015,0.000459151351346182,0.000448483936561052,0.000438015036626326,0.000427742368101298,0.000417663680705778,0.00040777675623538,0.000398079407514787,0.00038856947738988,0.000379244837756175,0.000370103388622168,0.000361143057206825,0.000352361797069688,0.000343757587272175,0.000335328431569736,0.000327072357632442,0.000318987416294804,0.000311071680831543,0.000303323246260795,0.000295740228671791,0.000288320764577203,0.000281063010289167,0.000273965141317947,0.000267025351792481,0.000260241853902435,0.000253612877360241,0.000247136668883624,0.000240811491696365,0.000234635625048568,0.000228607363753768,0.000222725017744021,0.000216986911641399,0.000211391384345613,0.000205936788637245,0.000200621490796201,0.000195443870234452,0.00019040231914336,0.000185495242154035,0.000180721056011651,0.000176078189261817,0.000171565081949823,0.000167180185331708,0.000162921961596859,0.000158788883601901,0.000154779434615492,0.000150892108073473,0.000147125407344495,0.0001434778455051,0.000139947945124878,0.000136534238060259,0.000133235265257879,0.000130049576566184,0.00012697573055561,0.00012401229434691,0.000121157843447357,0.000118410961594507,0.000115770240607543,0.000113234280245516,0.000110801688072885,0.00010847107933134,0.000106241076818658,0.000104110310773355,0.000102077418765823,0.000100141045595229,9.82998431921735e-05,9.65524705268698e-05,9.48975935228072e-05,9.33338849754342e-05,9.18600244761432e-05,9.04746983408026e-05,8.91765995434061e-05,8.79644276539039e-05,8.6836888780736e-05,8.57926955175458e-05,8.48305668940252e-05,8.39492283307793e-05,8.31474115981145e-05,8.24238547784548e-05,8.17773022325704e-05,8.12065045690491e-05,8.07102186174787e-05
};

float32_t tonicCoeffsFIR[512] = {
    // Stage 1
		0.00027407666116661,0.000274340035646964,0.000274841507009337,0.000275581393217304,0.000276559973314694,0.000277777487342471,0.000279234136262187,0.000280930081886001,0.000282865446813298,0.000285040314373914,0.000287454728577989,0.000290108694072462,0.000293002176104209,0.000296135100489858,0.000299507353592263,0.000303118782303673,0.000306969194035591,0.000311058356715322,0.000315385998789237,0.000319951809232738,0.000324755437566938,0.000329796493882055,0.000335074548867518,0.000340589133848794,0.000346339740830923,0.000352325822548765,0.000358546792523961,0.000365002025128585,0.000371690855655499,0.000378612580395401,0.000385766456720543,0.000393151703175131,0.000400767499572375,0.000408612987098196,0.00041668726842156,0.00042498940781144,0.000433518431260375,0.000442273326614625,0.000451253043710891,0.000460456494519587,0.000469882553294643,0.000479530056729823,0.000489397804121519,0.000499484557538021,0.000509789041995212,0.000520309945638688,0.000531045919932258,0.000541995579852797,0.000553157504091432,0.000564530235261023,0.000576112280109912,0.000587902109741897,0.000599898159842413,0.00061209883091087,0.000624502488499122,0.000637107463456028,0.000649912052178056,0.000662914516865907,0.00067611308578711,0.000689505953544543,0.000703091281350844,0.000716867197308667,0.000730831796696734,0.000744983142261643,0.000759319264515376,0.000773838162038476,0.000788537801788822,0.000803416119415972,0.000818471019581008,0.000833700376281844,0.000849102033183932,0.000864673803956319,0.000880413472613003,0.000896318793859521,0.000912387493444727,0.000928617268517686,0.000945005787989642,0.000961550692900986,0.000978249596793173,0.000995100086085522,0.00101209972045684,0.00102924603323181,0.00104653653177203,0.0010639686978718,0.00108153998815829,0.00109924783449639,0.00111708964439786,0.00113506280143493,0.0011531646656581,0.00117139257401826,0.00118974384079292,0.00120821575801649,0.0012268055959146,0.0012455106033424,0.00126432800822663,0.00128325501801153,0.00130228882010851,0.00132142658234934,0.00134066545344301,0.00136000256343602,0.00137943502417611,0.00139895992977926,0.00141857435710001,0.00143827536620491,0.00145806000084907,0.00147792528895571,0.00149786824309865,0.00151788586098764,0.00153797512595645,0.00155813300745368,0.00157835646153607,0.00159864243136445,0.00161898784770202,0.00163938962941504,0.00165984468397571,0.00168034990796731,0.00170090218759136,0.00172149839917678,0.00174213540969106,0.00176281007725309,0.0017835192516479,0.00180425977484294,0.00182502848150596,0.00184582219952439,0.00186663775052602,0.0018874719504011,0.00190832160982554,0.0019291835347853,0.00195005452710174,0.00197093138495798,0.00199181090342604,0.00201268987499479,0.00203356509009853,0.00205443333764619,0.00207529140555092,0.00209613608126021,0.00211696415228617,0.00213777240673613,0.00215855763384332,0.00217931662449754,0.00220004617177584,0.00222074307147299,0.0022414041226317,0.00226202612807258,0.00228260589492355,0.00230314023514884,0.00232362596607729,0.00234405991093004,0.00236443889934731,0.00238475976791443,0.00240501936068677,0.00242521452971367,0.0024453421355612,0.0024653990478337,0.00248538214569388,0.00250528831838165,0.00252511446573129,0.0025448574986871,0.00256451433981731,0.0025840819238262,0.00260355719806441,0.0026229371230372,0.00264221867291071,0.00266139883601608,0.00268047461535133,0.00269944302908093,0.00271830111103296,0.00273704591119384,0.00275567449620038,0.00277418394982928,0.00279257137348383,0.00281083388667781,0.00282896862751645,0.00284697275317441,0.00286484344037069,0.00288257788584039,0.00290017330680319,0.00291762694142851,0.00293493604929734,0.00295209791186047,0.00296910983289326,0.00298596913894668,0.00300267317979468,0.00301921932887778,0.00303560498374269,0.00305182756647809,0.00306788452414631,0.00308377332921088,0.00309949147996001,0.0031150365009257,0.00313040594329861,0.00314559738533843,0.00316060843277992,0.00317543671923428,0.00319007990658598,0.00320453568538489,0.00321880177523365,0.00323287592517026,0.00324675591404575,0.00326043955089691,0.00327392467531402,0.00328720915780349,0.00330029090014536,0.0033131678357456,0.00332583792998315,0.00333829918055161,0.00335054961779559,0.00336258730504155,0.0033744103389232,0.00338601684970133,0.00339740500157798,0.003408572993005,0.00341951905698682,0.00343024146137756,0.00344073850917215,0.0034510085387917,0.00346104992436289,0.0034708610759914,0.00348044044002926,0.00348978649933625,0.003498897773535,0.00350777281926014,0.00351641023040103,0.00352480863833843,0.00353296671217474,0.00354088315895799,0.00354855672389942,0.0035559861905847,0.00356317038117863,0.00357010815662342,0.00357679841683046,0.00358324010086547,0.00358943218712717,0.00359537369351925,0.00360106367761577,0.00360650123681979,0.00361168550851543,0.0036166156702131,0.00362129093968802,0.00362571057511197,0.00362987387517824,0.00363378017921972,0.00363742886732022,0.00364081936041885,0.00364395112040762,0.00364682365022203,0.00364943649392481,0.00365178923678279,0.00365388150533669,0.00365571296746408,0.00365728333243533,0.00365859235096258,0.00365963981524175,0.00366042555898754,0.00366094945746146,0.00366121142749284,0.00366121142749284,0.00366094945746146,0.00366042555898754,0.00365963981524175,0.00365859235096258,0.00365728333243533,0.00365571296746408,0.00365388150533669,0.00365178923678279,0.00364943649392481,0.00364682365022203,0.00364395112040762,0.00364081936041885,0.00363742886732022,0.00363378017921972,0.00362987387517824,0.00362571057511197,0.00362129093968802,0.0036166156702131,0.00361168550851543,0.00360650123681979,0.00360106367761577,0.00359537369351925,0.00358943218712717,0.00358324010086547,0.00357679841683046,0.00357010815662342,0.00356317038117863,0.0035559861905847,0.00354855672389942,0.00354088315895799,0.00353296671217474,0.00352480863833843,0.00351641023040103,0.00350777281926014,0.003498897773535,0.00348978649933625,0.00348044044002926,0.0034708610759914,0.00346104992436289,0.0034510085387917,0.00344073850917215,0.00343024146137756,0.00341951905698682,0.003408572993005,0.00339740500157798,0.00338601684970133,0.0033744103389232,0.00336258730504155,0.00335054961779559,0.00333829918055161,0.00332583792998315,0.0033131678357456,0.00330029090014536,0.00328720915780349,0.00327392467531402,0.00326043955089691,0.00324675591404575,0.00323287592517026,0.00321880177523365,0.00320453568538489,0.00319007990658598,0.00317543671923428,0.00316060843277992,0.00314559738533843,0.00313040594329861,0.0031150365009257,0.00309949147996001,0.00308377332921088,0.00306788452414631,0.00305182756647809,0.00303560498374269,0.00301921932887778,0.00300267317979468,0.00298596913894668,0.00296910983289326,0.00295209791186047,0.00293493604929734,0.00291762694142851,0.00290017330680319,0.00288257788584039,0.00286484344037069,0.00284697275317441,0.00282896862751645,0.00281083388667781,0.00279257137348383,0.00277418394982928,0.00275567449620038,0.00273704591119384,0.00271830111103296,0.00269944302908093,0.00268047461535133,0.00266139883601608,0.00264221867291071,0.0026229371230372,0.00260355719806441,0.0025840819238262,0.00256451433981731,0.0025448574986871,0.00252511446573129,0.00250528831838165,0.00248538214569388,0.0024653990478337,0.0024453421355612,0.00242521452971367,0.00240501936068677,0.00238475976791443,0.00236443889934731,0.00234405991093004,0.00232362596607729,0.00230314023514884,0.00228260589492355,0.00226202612807258,0.0022414041226317,0.00222074307147299,0.00220004617177584,0.00217931662449754,0.00215855763384332,0.00213777240673613,0.00211696415228617,0.00209613608126021,0.00207529140555092,0.00205443333764619,0.00203356509009853,0.00201268987499479,0.00199181090342604,0.00197093138495798,0.00195005452710174,0.0019291835347853,0.00190832160982554,0.0018874719504011,0.00186663775052602,0.00184582219952439,0.00182502848150596,0.00180425977484294,0.0017835192516479,0.00176281007725309,0.00174213540969106,0.00172149839917678,0.00170090218759136,0.00168034990796731,0.00165984468397571,0.00163938962941504,0.00161898784770202,0.00159864243136445,0.00157835646153607,0.00155813300745368,0.00153797512595645,0.00151788586098764,0.00149786824309865,0.00147792528895571,0.00145806000084907,0.00143827536620491,0.00141857435710001,0.00139895992977926,0.00137943502417611,0.00136000256343602,0.00134066545344301,0.00132142658234934,0.00130228882010851,0.00128325501801153,0.00126432800822663,0.0012455106033424,0.0012268055959146,0.00120821575801649,0.00118974384079292,0.00117139257401826,0.0011531646656581,0.00113506280143493,0.00111708964439786,0.00109924783449639,0.00108153998815829,0.0010639686978718,0.00104653653177203,0.00102924603323181,0.00101209972045684,0.000995100086085522,0.000978249596793173,0.000961550692900986,0.000945005787989642,0.000928617268517686,0.000912387493444727,0.000896318793859521,0.000880413472613003,0.000864673803956319,0.000849102033183932,0.000833700376281844,0.000818471019581008,0.000803416119415972,0.000788537801788822,0.000773838162038476,0.000759319264515376,0.000744983142261643,0.000730831796696734,0.000716867197308667,0.000703091281350844,0.000689505953544543,0.00067611308578711,0.000662914516865907,0.000649912052178056,0.000637107463456028,0.000624502488499122,0.00061209883091087,0.000599898159842413,0.000587902109741897,0.000576112280109912,0.000564530235261023,0.000553157504091432,0.000541995579852797,0.000531045919932258,0.000520309945638688,0.000509789041995212,0.000499484557538021,0.000489397804121519,0.000479530056729823,0.000469882553294643,0.000460456494519587,0.000451253043710891,0.000442273326614625,0.000433518431260375,0.00042498940781144,0.00041668726842156,0.000408612987098196,0.000400767499572375,0.000393151703175131,0.000385766456720543,0.000378612580395401,0.000371690855655499,0.000365002025128585,0.000358546792523961,0.000352325822548765,0.000346339740830923,0.000340589133848794,0.000335074548867518,0.000329796493882055,0.000324755437566938,0.000319951809232738,0.000315385998789237,0.000311058356715322,0.000306969194035591,0.000303118782303673,0.000299507353592263,0.000296135100489858,0.000293002176104209,0.000290108694072462,0.000287454728577989,0.000285040314373914,0.000282865446813298,0.000280930081886001,0.000279234136262187,0.000277777487342471,0.000276559973314694,0.000275581393217304,0.000274841507009337,0.000274340035646964,0.00027407666116661
};

float32_t filteredCoeffsFIR[64] = {
		-0.000824653693879865,-0.000857063599528832,-0.000917709358691571,-0.000998343370055928,-0.00108384074801422,-0.0011523411588914,-0.00117581379933528,-0.00112103656571915,-0.000950957627525943,-0.000626385789779614,-0.000107936395438303,0.000641856829360566,0.00165636570710357,0.00296273620184231,0.00457991227749526,0.00651692169375343,0.00877152091214354,0.0113292815939579,0.0141631819426329,0.0172337432742739,0.0204897267915738,0.0238693788351055,0.027302186221824,0.0307110779984051,0.0340149873267174,0.0371316684480026,0.039980649725202,0.0424861953872828,0.0445801462670205,0.0462045137037207,0.0473137107311918,0.0478763202382504,0.0478763202382504,0.0473137107311918,0.0462045137037207,0.0445801462670205,0.0424861953872828,0.039980649725202,0.0371316684480026,0.0340149873267174,0.0307110779984051,0.027302186221824,0.0238693788351055,0.0204897267915738,0.0172337432742739,0.0141631819426329,0.0113292815939579,0.00877152091214354,0.00651692169375343,0.00457991227749526,0.00296273620184231,0.00165636570710357,0.000641856829360566,-0.000107936395438303,-0.000626385789779614,-0.000950957627525943,-0.00112103656571915,-0.00117581379933528,-0.0011523411588914,-0.00108384074801422,-0.000998343370055928,-0.000917709358691571,-0.000857063599528832,-0.000824653693879865
};

float32_t phasicCoeffs[NUM_STAGES_2ORDER*5] = {
    // Stage 1

		0.998266003962435,	-1.99653200792487,	0.998266003962435,	1.99652900118035,	-0.996535014669388
};
float32_t tonicCoeffs[NUM_STAGES_2ORDER*5] = {
    // Stage 1
		6.00307975164863e-06,	1.20061595032973e-05,	6.00307975164863e-06,	1.99305802314321,	-0.993082035462212
};
float32_t filteredCoeffs[NUM_STAGES_2ORDER*5] = {
    // Stage 1
		0.00490303497078511,	0.00980606994157022	,0.00490303497078511,	1.79238563711149,	-0.811997776994632
};
/* State buffer for the biquad filter */


static float32_t phasicState[NUM_TAPS+BLOCK_SIZE-1];
static float32_t tonicState[512+BLOCK_SIZE-1];
static float32_t filteredState[64+BLOCK_SIZE-1];


static arm_fir_instance_f32 S_phasic;
static arm_fir_instance_f32 S_tonic;
static arm_fir_instance_f32 S_filtered;

float32_t outputphasic[BLOCK_SIZE];
float32_t outputtonic[BLOCK_SIZE];
float32_t outputfiltered[BLOCK_SIZE];


uint32_t n_sample = 0;
float32_t conductanceSample[BLOCK_SIZE];
int32_t biozSample[BLOCK_SIZE];
float32_t reverseSample[BLOCK_SIZE];
uint32_t skip_sample = 0;


float32_t phasic_window[PAST_SAMPLE_BUFFER];

static  float32_t previous_1 = 0;
static  float32_t previous_2 = 0;
uint8_t valid_peak = 0;
float32_t peak[BLOCK_SIZE];
float32_t onset[BLOCK_SIZE];
float_t n_peak = 0;         //Puo benissimo essere uint8, ma torna meglio interpretare da python tutti i valori come float mentre legge i dati trasmessi

uint8_t SCR_rise_sample = 0;
float32_t SCR_risetime = 0;
float32_t risetime_mean = 0;
//float32_t old_risetime_mean = 0;
float32_t risetime_variance = 0;
float32_t risetime_std_dev = 0;
uint32_t risetime_count = 0;

float32_t tonic_mean = 0;
uint32_t tonic_count = 0;
uint16_t tonic_mean_settling = 0;
float32_t tonic_buffer[WINDOW];

float32_t phasic_mean = 0;
uint32_t phasic_count = 0;
uint16_t phasic_mean_settling = 0;
float32_t phasic_buffer[WINDOW];

float32_t max_tonic = 0;
uint16_t max_tonic_settling = 0;

uint32_t baseline_period = 0;
uint8_t baseline_calculated = 0;

float32_t conductance_mean = 0;
float32_t conductance_variance = 0;
float32_t conductance_std_dev = 0;
uint32_t conductance_count = 0;
float32_t conductance_buffer[WINDOW];

uint32_t window = 0;
uint32_t bufferIdx = 0;

float32_t features[5];
float32_t out;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void SystemPower_Config(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
int _write(int file, char *ptr, int len){
	HAL_UART_Transmit(&huart1, (uint8_t*)ptr, len, HAL_MAX_DELAY);
	return len;
}

void Printing(){
	phasic_mean = 0;
	tonic_mean = 0;
	max_tonic = 0;
	n_peak = 0;
	risetime_std_dev = 0;

	phasic_count = 0;
	tonic_count = 0;
	risetime_count = 0;
}

void StdDev(float32_t sig, uint32_t* count, float32_t *average, float32_t *variance, float32_t *stddev){
	float32_t oldavg = *average;

	(*count)++;
	*average = *average + (sig-*average) / *count;
	(*variance) += ((sig - *average) * (sig - oldavg));

	arm_sqrt_f32(*variance/(*count), stddev);

}


void Local_Peak_and_Onset(float32_t signal,float32_t *peak, float32_t *onset, float32_t *peak_sum) {
	SCR_risetime = 0;
	if(valid_peak > 0){
	    		valid_peak--; // valid_peak pone un limite al phasic_window nel caso avessi trovato un vald peak
	    	}

    if (previous_1 > previous_2 && previous_1 > signal) {
    	previous_2 = previous_1;
    	previous_1 = signal;



    	float32_t lowest_point = phasic_window[1]; //Inizia con punto piu basso il primo sample passato per
    	SCR_rise_sample = 1;
		for (uint8_t i = 1; i < PAST_SAMPLE_BUFFER-valid_peak; i++) {	//Inzia ricerca del punto piu basso per trovare onset spostandomi un sample alla volta verso il passato
			if (phasic_window[i] < lowest_point) {
				SCR_rise_sample = i;			 //Rise time è uguale ad i siccome è il numero di sample tra onset e picco

				lowest_point = phasic_window[i];
			}
		}
		if (previous_2 - lowest_point > 2.6){  //3.112026184437658e-07 non normalized threshold
			*onset = lowest_point;
			*peak = previous_2;
			(*peak_sum)++; 						 //Somma picchi per trovare numero totale
			valid_peak = PAST_SAMPLE_BUFFER - 1; //valid peak assume il valore massimo del past buffer limitando il window fino a quel punto
			SCR_risetime = SCR_rise_sample; 	 //Trovo il valore del rise time del picco
			StdDev(SCR_risetime/32, &risetime_count, &risetime_mean, &risetime_variance, &risetime_std_dev);

		}
		else{
			*onset = 0;
			*peak = 0;


		}
    }
    else{
    	previous_2 = previous_1;
		previous_1 = signal;

		*onset = 0;
		*peak = 0;
    }
}

void Phasic_window(float32_t phasic){

	for (uint8_t i = PAST_SAMPLE_BUFFER; i > 0; i--) {
	        phasic_window[i - 1] = phasic_window[ i - 2]; //shifto a destra valore vecchio, applicando metodo FIFO giunto alla fine del buffer
	    }

	phasic_window[0] = phasic; //Salvo il valore piu nuovo all'inizio del buffer

}

void Max_Signal(float32_t signal, float32_t* max, uint16_t *settling){
	if (*max < signal){
			*max = signal;
		}


}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart){
	ecgFIFOIntFlag = 1;
}

void Mean(float32_t sig, uint32_t* count, float32_t *average, uint16_t *settling){
	(*count)++;
	*average = *average + (sig-*average) / *count;


}


/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* Configure the System Power */
  SystemPower_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_ADC1_Init();
  MX_UCPD1_Init();
  MX_USART1_UART_Init();
  MX_USB_OTG_FS_PCD_Init();
  MX_SPI1_Init();
  /* USER CODE BEGIN 2 */
  //max30003Config();
  //max30003BeginRtorMode(); 	//Configures and enable ECG/RTOR
  //max30001gBeginBIOZ(); 		//Configures and enable BIOZ

//  max30003ReadInfo();
//  max30003Printconf();

  arm_fir_init_f32(&S_phasic, NUM_TAPS, (float32_t*)phasicCoeffsFIR, phasicState, BLOCK_SIZE);
  arm_fir_init_f32(&S_tonic, 512, (float32_t*)tonicCoeffsFIR, tonicState, BLOCK_SIZE);
  arm_fir_init_f32(&S_filtered, 64, (float32_t*)filteredCoeffsFIR, filteredState, BLOCK_SIZE);
  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */


	  HAL_UART_Receive_IT(&huart1, receivedData, 8);
	  memcpy(&outputtonic, receivedData, sizeof(float32_t));
	  memcpy(&outputphasic, receivedData + 4, sizeof(float32_t));

	  if( ecgFIFOIntFlag ) {
		  ecgFIFOIntFlag = 0;
		  if (baseline_period == 0){

			  for (uint8_t i = 0; i < BLOCK_SIZE; i++) {

				  Phasic_window(outputphasic[i]);
				  Local_Peak_and_Onset(outputphasic[i], &peak[i], &onset[i], &n_peak);
				  Mean(outputtonic[i], &tonic_count, &tonic_mean, &tonic_mean_settling);
				  Mean(outputphasic[i], &phasic_count, &phasic_mean, &phasic_mean_settling);
				  Max_Signal(outputtonic[i], &max_tonic, &max_tonic_settling);

				  features[0] = tonic_mean;
			      features[1] = phasic_mean;
			      features[2] = max_tonic;
			      features[3] = n_peak;
			      features[4] = risetime_std_dev;



				  if (window > 32*30 - 1){

					  out = sonar_predict(features, 5);
					  tonic_mean = 0;
					  phasic_mean = 0;
					  tonic_count = 0;
					  phasic_count = 0;
					  max_tonic = 0;
					  n_peak = 0;
					  risetime_std_dev = 0;
					  risetime_mean = 0;
					  risetime_variance = 0;
					  risetime_count = 0;
					  HAL_UART_Transmit(&huart1, (uint8_t*)&out, 4, HAL_MAX_DELAY);
					  valid_peak = PAST_SAMPLE_BUFFER - 1;

					  window = 0;
				  }
				  else{

					  window++;
				  }
			  }
		  }
		  else{
			  StdDev(conductanceSample[0], &conductance_count, &conductance_mean, &conductance_variance, &conductance_std_dev);
			  baseline_period++;
		  }
		}
	  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  if (HAL_PWREx_ControlVoltageScaling(PWR_REGULATOR_VOLTAGE_SCALE1) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI48|RCC_OSCILLATORTYPE_HSI
                              |RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSI48State = RCC_HSI48_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSICalibrationValue = RCC_MSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_4;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLMBOOST = RCC_PLLMBOOST_DIV1;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 80;
  RCC_OscInitStruct.PLL.PLLP = 2;
  RCC_OscInitStruct.PLL.PLLQ = 2;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLRGE = RCC_PLLVCIRANGE_0;
  RCC_OscInitStruct.PLL.PLLFRACN = 0;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2
                              |RCC_CLOCKTYPE_PCLK3;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB3CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief Power Configuration
  * @retval None
  */
static void SystemPower_Config(void)
{

  /*
   * Switch to SMPS regulator instead of LDO
   */
  if (HAL_PWREx_ConfigSupply(PWR_SMPS_SUPPLY) != HAL_OK)
  {
    Error_Handler();
  }
/* USER CODE BEGIN PWR */
/* USER CODE END PWR */
}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
